<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <!-- ç¦ç”¨ç¼©æ”¾ï¼Œé¿å…åŒå‡»/æåˆæ”¾å¤§ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LoveStory - ç”µå½±ç«™ç‚¹</title>

  <!-- DPlayer & HLS -->
  <link rel="stylesheet" href="https://unpkg.com/dplayer/dist/DPlayer.min.css">
  <script src="https://unpkg.com/hls.js@latest/dist/hls.min.js"></script>
  <script src="https://unpkg.com/dplayer/dist/DPlayer.min.js"></script>

  <!-- é¢„è¿æ¥ç¬¬ä¸‰æ–¹åŸŸå -->
  <link rel="preconnect" href="https://img.hgimg00.com" crossorigin>
  <link rel="dns-prefetch" href="//img.hgimg00.com">
  <link rel="preconnect" href="https://player.hgcdn666.com" crossorigin>
  <link rel="dns-prefetch" href="//player.hgcdn666.com">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{
      --bg:#0b0d12; --top:#101522; --muted:#b9c1d1; --card:#1d2431;
      --pill:#2b3446; --pill-active:#ff2d7a; --accent:#ff2d7a; --accent2:#ffd369;
      --danger:#e94560;
    }
    html,body{ height:100%; touch-action: manipulation; } /* é˜²åŒå‡»æ”¾å¤§ */
    body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial; background: linear-gradient(#0f1320,#0a0d16); color:#fff; }

    /* é¡¶éƒ¨æ¡ */
    .topbar{position:sticky;top:0;z-index:20;background:var(--top);padding:10px 12px;border-bottom:1px solid #111827;}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
    .logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:18px;color:#ff6b81;}
    .searchbar{display:flex;gap:8px}
    .searchbar input{flex:1;height:36px;border-radius:8px;border:none;padding:0 12px;background:#0f1524;color:#e5e7eb;outline:none}
    .searchbar button{height:36px;border:none;border-radius:8px;padding:0 12px;background:var(--accent);color:#fff;cursor:pointer}
    .tabs{display:flex;gap:10px;overflow-x:auto;padding:10px 0 4px}
    .tabs::-webkit-scrollbar{display:none}
    .tab{white-space:nowrap;padding:6px 12px;border-radius:16px;background:var(--pill);cursor:pointer}
    .tab.active{background:var(--pill-active)}

    /* çŠ¶æ€æ¡ */
    #statusBar{display:flex;align-items:center;gap:8px;color:#e5e7eb;font-size:13px;padding:6px 2px}
    #statusBar .sp{width:14px;height:14px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
    #statusBar button{border:none;background:var(--accent2);color:#000;border-radius:6px;padding:4px 8px;cursor:pointer}
    @keyframes spin{to{transform:rotate(360deg)}}

    main{padding:12px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin:14px 0 8px}
    .section-title{font-weight:700}
    .more{font-size:13px;color:#d1d5db;cursor:pointer}

    /* ç½‘æ ¼ï¼š2 åˆ— */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}

    /* å¡ç‰‡ï¼šå°é¢é«˜ 110pxï¼ˆå›¾æº 320x240ï¼‰ */
    .card{background:var(--card);border-radius:10px;overflow:hidden;cursor:pointer;border:1px solid #182034}
    .thumb-wrap{position:relative;width:100%;height:110px;background:#0e1627}
    .thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block;filter:blur(12px);transition:filter .3s ease}
    .thumb.loaded{filter:blur(0)}
    .badge-corner{position:absolute;left:8px;top:8px;font-size:11px;padding:2px 6px;border-radius:999px;background:#ff2d7a;color:#fff}
    .meta-bar{position:absolute;left:6px;right:6px;bottom:6px;display:flex;gap:10px;align-items:center;background:rgba(0,0,0,.35);border-radius:8px;padding:2px 6px;font-size:12px}
    .meta{display:flex;align-items:center;gap:10px;color:#e5e7eb}
    .info{padding:8px 10px}
    .title{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#f3f4f6}

    /* åˆ†é¡µ */
    .pagination{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:14px 0}
    .pagination button,.pagination span{background:#293147;border:none;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
    .pagination .active{background:var(--accent2);color:#000}
    .pagination .ellipsis{background:transparent;cursor:default}

    .empty{color:#9ca3af;text-align:center;padding:24px 0}

    footer{padding:20px;text-align:center;background:#0f1524;color:#cbd5e1}

    /* å¼¹å±‚/æ’­æ”¾å™¨/Toast */
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center;padding:14px}
    .modal,.player{background:#fff;color:#000;border-radius:16px;width:92%;max-width:560px;position:relative;padding:16px}
    /* æé«˜å…³é—­æŒ‰é’®å±‚çº§ï¼Œç¡®ä¿å‹è¿‡ DPlayer */
    .overlay .close{position:absolute;right:10px;top:10px;border:none;border-radius:50%;width:34px;height:34px;line-height:34px;background:var(--danger);color:#fff;font-size:20px;cursor:pointer;z-index:1000;box-shadow:0 4px 16px rgba(0,0,0,.35)}
    .price-btn{display:block;width:82%;margin:10px auto;padding:10px;border:none;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
    .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;border-radius:8px;padding:10px 16px;display:none;z-index:200}

    /* DPlayer å®¹å™¨ï¼šä¸»ä½“é™ä½å±‚çº§ï¼Œå…³é—­æŒ‰é’®ç½®é¡¶ */
    .player-body{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;z-index:1}
    #dplayer{position:absolute;inset:0;z-index:1}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">âˆâˆ çˆ± LoveStory</div>
    </div>
    <div class="searchbar">
      <input id="searchInput" type="search" placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹" />
      <button id="searchBtn">æœç´¢</button>
    </div>
    <div class="tabs" id="parentTabs"></div>
    <div id="statusBar"><span class="sp"></span><span id="statusText">æ­£åœ¨åŠ è½½åˆ†ç±»â€¦</span><button id="retryBtn" style="display:none">é‡è¯•</button></div>
  </div>

  <main>
    <!-- é¦–é¡µï¼šå­ç±»åˆ†åŒºå®¹å™¨ -->
    <div id="homeWrap"></div>

    <!-- åˆ—è¡¨æ¨¡å¼ï¼ˆæŸä¸ªå­ç±»ï¼‰ -->
    <div id="listWrap" style="display:none">
      <div class="section-header"><div class="section-title" id="listTitle">åˆ—è¡¨</div></div>
      <div id="listGrid" class="grid"></div>
      <div id="pagination" class="pagination"></div>
    </div>

    <!-- æœç´¢æ¨¡å¼ -->
    <div id="searchWrap" style="display:none">
      <div class="section-header"><div class="section-title">æœç´¢ç»“æœ</div></div>
      <div id="searchGrid" class="grid"></div>
      <div id="searchPagination" class="pagination"></div>
    </div>
  </main>

  <footer>ICPå¤‡æ¡ˆå·ï¼šäº¬ICPå¤‡12345678å·-1</footer>

  <!-- ä»˜è´¹å¼¹å±‚ -->
  <div id="payOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="close" onclick="closePay()">Ã—</button>
      <h3 style="text-align:center;margin-bottom:8px">è§‚çœ‹æ­¤è§†é¢‘éœ€ä»˜è´¹</h3>
      <button class="price-btn" onclick="selectPlan('3å…ƒå•ç‰‡')">å•éƒ¨è§‚çœ‹ï¼š3å…ƒ</button>
      <button class="price-btn" onclick="selectPlan('10å…ƒä¸€å°æ—¶ä¼šå‘˜')">ä¼šå‘˜1å°æ—¶ï¼š10å…ƒ</button>
      <button class="price-btn" onclick="selectPlan('29.9å…ƒæ°¸ä¹…ä¼šå‘˜')">æ°¸ä¹…ä¼šå‘˜ï¼š29.9å…ƒ</button>
    </div>
  </div>

  <!-- DPlayer æ’­æ”¾å™¨å¼¹å±‚ -->
  <div id="playerOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="player">
      <button class="close" onclick="closePlayer()">Ã—</button>
      <div class="player-body">
        <div id="dplayer"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ======= å…¨å±€åŒå‡»/æ‰‹åŠ¿æ”¾å¤§æ‹¦æˆª ======= */
    document.addEventListener('dblclick', e => e.preventDefault());
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if(now - lastTouchEnd <= 300){ e.preventDefault(); }
      lastTouchEnd = now;
    }, {passive:false});
    ['gesturestart','gesturechange','gestureend'].forEach(evt=>{
      document.addEventListener(evt, e=> e.preventDefault());
    });

    // refs
    const parentTabs = document.getElementById('parentTabs');
    const statusBar = document.getElementById('statusBar');
    const statusText = document.getElementById('statusText');
    const retryBtn   = document.getElementById('retryBtn');

    const homeWrap   = document.getElementById('homeWrap');
    const listWrap   = document.getElementById('listWrap');
    const listTitle  = document.getElementById('listTitle');
    const listGrid   = document.getElementById('listGrid');
    const pagination = document.getElementById('pagination');

    const searchWrap = document.getElementById('searchWrap');
    const searchGrid = document.getElementById('searchGrid');
    const searchPagination = document.getElementById('searchPagination');

    const payOverlay = document.getElementById('payOverlay');
    const playerOverlay = document.getElementById('playerOverlay');
    const toastEl = document.getElementById('toast');

    const searchInput = document.getElementById('searchInput');
    const searchBtn   = document.getElementById('searchBtn');

    // DPlayer å®ä¾‹
    let dp = null;

    // state
    let categories = [];
    let parentIdx = 0;
    let childId   = null;
    let selectedVideoUrl = '';
    let selectedCover = '';
    let planLock = false;

    // list/search pagination
    let currentPage = 1;
    const perPage   = 20;
    let lastPage    = 1;

    // helpers
    function showToast(msg, ms=2000){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(()=>toastEl.style.display='none', ms);
    }
    function setStatus(text, spinning=true, retry=false){
      statusText.textContent = text || '';
      statusBar.querySelector('.sp').style.display = spinning ? 'inline-block' : 'none';
      retryBtn.style.display = retry ? 'inline-block' : 'none';
      statusBar.style.display = text ? 'flex' : 'none';
    }
    retryBtn.onclick = ()=> init(true);

    function escapeHtml(s=''){ return String(s).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // fetch with timeout
    async function fetchWithTimeout(url, {timeout=8000, ...opts}={}){
      const ctl = new AbortController();
      const id = setTimeout(()=>ctl.abort(), timeout);
      try{ return await fetch(url, {...opts, signal: ctl.signal}); }
      finally{ clearTimeout(id); }
    }

    const API = {
      async categories(){
        const url = 'https://api.4love4.com/api/video_categories';
        const r = await fetchWithTimeout(url);
        if(!r.ok) throw new Error('åˆ†ç±»è¯·æ±‚å¤±è´¥ '+r.status);
        const j = await r.json(); return j.data||[];
      },
      async videos(page, per_page, cid){
        const u = new URL('https://api.4love4.com/api/videos');
        u.searchParams.set('page', page);
        u.searchParams.set('per_page', per_page);
        if(cid) u.searchParams.set('category_id', cid);
        const r = await fetchWithTimeout(u.toString());
        if(!r.ok) throw new Error('è§†é¢‘è¯·æ±‚å¤±è´¥ '+r.status);
        return await r.json();
      },
      async search(page, per_page, keyword){
        const u = new URL('https://api.4love4.com/api/search');
        u.searchParams.set('page', page);
        u.searchParams.set('per_page', per_page);
        u.searchParams.set('keyword', keyword || '');
        const r = await fetchWithTimeout(u.toString());
        if(!r.ok) throw new Error('æœç´¢è¯·æ±‚å¤±è´¥ '+r.status);
        return await r.json();
      }
    };

    // tabs
    function renderParentTabs(){
      parentTabs.innerHTML = '';
      categories.forEach((p, i)=>{
        const el = document.createElement('div');
        el.className = 'tab' + (i===parentIdx?' active':'');
        el.textContent = p.name;
        el.onclick = ()=>{
          parentIdx = i;
          switchToHome();
        };
        parentTabs.appendChild(el);
      });
    }

    // é¦–é¡µï¼šæŒ‰çˆ¶åˆ†ç±»æ¸²æŸ“æ‰€æœ‰å­ç±»åˆ†åŒºï¼Œæ¯ä¸ªå­ç±»å–å‰4æ¡
    async function renderHomeSections(){
      homeWrap.innerHTML = '';
      const parent = categories[parentIdx];
      if(!parent){ return; }
      const children = parent.children || [];
      if(!children.length){
        homeWrap.innerHTML = '<div class="empty">è¯¥åˆ†ç±»ä¸‹æš‚æ— å­ç±»</div>';
        return;
      }
      for(const ch of children){
        const sec = document.createElement('section');

        const header = document.createElement('div');
        header.className = 'section-header';
        header.innerHTML = `<div class="section-title">${escapeHtml(ch.name)}</div><div class="more">æ›´å¤š</div>`;
        header.querySelector('.more').onclick = ()=> switchToList(ch.id, ch.name);
        sec.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'grid';
        for(let i=0;i<4;i++){
          const sk = document.createElement('div');
          sk.className = 'card';
          sk.innerHTML = `<div class="thumb-wrap"></div><div class="info"><div class="title">åŠ è½½ä¸­â€¦</div></div>`;
          grid.appendChild(sk);
        }
        sec.appendChild(grid);
        homeWrap.appendChild(sec);

        try{
          const res = await API.videos(1, 4, ch.id);
          const list = res?.data || [];
          grid.innerHTML = '';
          list.forEach(item=> grid.appendChild(makeCard(item)));
        }catch(e){
          console.warn('å­ç±»åŠ è½½å¤±è´¥', ch.id, e);
          grid.innerHTML = `<div class="empty" style="grid-column:1/-1">åŠ è½½å¤±è´¥</div>`;
        }
      }
    }

    // åˆ—è¡¨æ¨¡å¼
    async function renderList(){
      listGrid.innerHTML = '';
      for(let i=0;i<perPage;i++){
        const sk = document.createElement('div');
        sk.className = 'card'; sk.innerHTML = `<div class="thumb-wrap"></div><div class="info"><div class="title">åŠ è½½ä¸­â€¦</div></div>`;
        listGrid.appendChild(sk);
      }
      try{
        setStatus('æ­£åœ¨åŠ è½½è§†é¢‘â€¦', true, false);
        const res = await API.videos(currentPage, perPage, childId);
        const list = res?.data||[];
        const meta = res?.meta;
        currentPage = Number(meta?.current_page||1);
        lastPage    = Number(meta?.last_page||1);
        listGrid.innerHTML = '';
        if(!list.length){ listGrid.innerHTML = '<div class="empty" style="grid-column:1/-1">æš‚æ— å†…å®¹</div>'; }
        else list.forEach(v=> listGrid.appendChild(makeCard(v)));
        renderPagination(pagination, currentPage, lastPage, (p)=>{ currentPage=p; renderList(); });
        setStatus('', false, false);
      }catch(e){
        console.error(e);
        setStatus('åŠ è½½è§†é¢‘å¤±è´¥', false, true);
        listGrid.innerHTML = '<div class="empty" style="grid-column:1/-1">åŠ è½½å¤±è´¥ <button onclick="renderList()">é‡è¯•</button></div>';
      }
    }

    // æœç´¢æ¨¡å¼
    async function renderSearch(keyword){
      searchGrid.innerHTML = '';
      for(let i=0;i<perPage;i++){
        const sk = document.createElement('div');
        sk.className = 'card'; sk.innerHTML = `<div class="thumb-wrap"></div><div class="info"><div class="title">åŠ è½½ä¸­â€¦</div></div>`;
        searchGrid.appendChild(sk);
      }
      try{
        setStatus(`æ­£åœ¨æœç´¢ï¼š${keyword}`, true, false);
        const res = await API.search(currentPage, perPage, keyword);
        const list = res?.data || [];
        const meta = res?.meta;
        currentPage = Number(meta?.current_page||1);
        lastPage    = Number(meta?.last_page||1);
        searchGrid.innerHTML = '';
        if(!list.length){ searchGrid.innerHTML = '<div class="empty" style="grid-column:1/-1">æ— åŒ¹é…ç»“æœ</div>'; }
        else list.forEach(v=> searchGrid.appendChild(makeCard({ ...v, category_name:'æœç´¢' })));
        renderPagination(searchPagination, currentPage, lastPage, (p)=>{ currentPage=p; renderSearch(keyword); });
        setStatus('', false, false);
      }catch(e){
        console.error(e);
        setStatus('æœç´¢å¤±è´¥', false, true);
        searchGrid.innerHTML = '<div class="empty" style="grid-column:1/-1">æœç´¢å¤±è´¥ <button onclick="doSearch()">é‡è¯•</button></div>';
      }
    }

    // å¡ç‰‡ï¼ˆç»Ÿä¸€ img é«˜ 110pxï¼‰
    function makeCard(item){
      const card = document.createElement('div');
      card.className = 'card';
      const low = item.cover_thumb || item.cover || './img/cover.png';
      const high = item.cover || item.cover_thumb || './img/cover.png';
      const duration = item.video_duration || '--:--';
      const views = item.views_label ?? item.views ?? 0;
      const likes = item.likes_label ?? item.likes ?? 0;

      card.innerHTML = `
        <div class="thumb-wrap">
          <img class="thumb" src="${low}" data-full="${high}" loading="lazy" decoding="async" alt="${escapeHtml(item.title)}">
          <div class="badge-corner">é™å…</div>
          <div class="meta-bar">
            <div class="meta">
              <span>ğŸ‘ï¸ ${views}</span>
              <span>ğŸ‘ ${likes}</span>
              <span>â± ${duration}</span>
            </div>
          </div>
        </div>
        <div class="info">
          <div class="title" title="${escapeHtml(item.title)}">${escapeHtml(item.title)}</div>
        </div>
      `;

      const img = card.querySelector('img');
      const ioImg = new IntersectionObserver(es=>{
        es.forEach(en=>{
          if(en.isIntersecting){
            const full = img.getAttribute('data-full');
            if(full){ img.src = full; }
            ioImg.unobserve(img);
          }
        });
      },{rootMargin:'200px 0px', threshold:0.01});
      img.addEventListener('load', ()=> img.classList.add('loaded'), {once:true});
      img.addEventListener('error', ()=>{ img.src='./img/cover.png'; img.classList.add('loaded'); }, {once:true});
      ioImg.observe(img);

      card.onclick = ()=>{
        selectedVideoUrl = item.video || '';   // æœç´¢æ¥å£æ—  video å­—æ®µæ—¶å¯èƒ½ä¸ºç©º
        selectedCover    = high;
        openPay();
      };
      return card;
    }

    // åˆ†é¡µï¼ˆçœç•¥å·æŠ˜å ï¼‰
    function renderPagination(container, cur, total, onGo){
      container.innerHTML='';
      const add=(label,page,active=false,disabled=false)=>{
        const b=document.createElement('button');
        b.textContent=label;
        if(active)b.classList.add('active');
        if(disabled){b.disabled=true;b.style.opacity=.5}
        b.onclick=()=>{ if(!disabled && page && page!==cur) onGo(page); };
        container.appendChild(b);
      };
      const el=()=>{ const s=document.createElement('span');s.className='ellipsis';s.textContent='...';container.appendChild(s); };
      add('ä¸Šä¸€é¡µ', Math.max(1,cur-1), false, cur===1);
      if(total<=7){ for(let p=1;p<=total;p++) add(String(p), p, p===cur); }
      else if(cur<=4){ [1,2,3,4,5].forEach(p=>add(String(p),p,p===cur)); el(); add(String(total), total, cur===total); }
      else if(cur>=total-3){ add('1',1,cur===1); el(); [total-4,total-3,total-2,total-1,total].forEach(p=>add(String(p),p,p===cur)); }
      else{ add('1',1,cur===1); el(); [cur-1,cur,cur+1].forEach(p=>add(String(p),p,p===cur)); el(); add(String(total), total, cur===total); }
      add('ä¸‹ä¸€é¡µ', Math.min(total,cur+1), false, cur===total);
    }

    // æ¨¡å¼åˆ‡æ¢
    function switchToHome(){
      homeWrap.style.display='block';
      listWrap.style.display='none';
      searchWrap.style.display='none';
      renderParentTabs();
      setStatus('åŠ è½½åˆ†åŒºä¸­â€¦', true, false);
      renderHomeSections().then(()=> setStatus('', false, false));
    }
    function switchToList(cid, title){
      childId = cid; currentPage = 1;
      listTitle.textContent = title || 'åˆ—è¡¨';
      homeWrap.style.display='none';
      listWrap.style.display='block';
      searchWrap.style.display='none';
      renderList();
    }
    function switchToSearch(){
      const kw = (searchInput.value||'').trim();
      if(!kw){ showToast('è¯·è¾“å…¥å…³é”®è¯'); return; }
      currentPage=1;
      homeWrap.style.display='none';
      listWrap.style.display='none';
      searchWrap.style.display='block';
      renderSearch(kw);
    }
    function doSearch(){ switchToSearch(); }
    searchBtn.onclick = doSearch;
    searchInput.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

    // ä»˜è´¹ & æ’­æ”¾ï¼ˆDPlayerï¼‰
    function openPay(){ payOverlay.style.display='flex'; }
    function closePay(){ payOverlay.style.display='none'; }

    function initDPlayer(url, cover){
      const container = document.getElementById('dplayer');
      if(dp){ try{ dp.destroy(); }catch(e){} dp=null; }
      const isHls = /\.m3u8(\?|$)/i.test(url);
      dp = new DPlayer({
        container,
        autoplay: true,
        theme: '#ff2d7a',
        preload: 'auto',
        screenshot: false,
        hotkey: true,
        video: {
          url: url,
          pic: cover || '',
          type: isHls ? 'hls' : 'auto'
        },
        contextmenu: []
      });
    }

    function selectPlan(plan){
      if(planLock) return; planLock = true;
      closePay(); showToast(`ä½ é€‰æ‹©äº†ï¼š${plan}`);
      setTimeout(()=>{
        if(!selectedVideoUrl){
          showToast('è¯¥æ¡ç›®æš‚æ— å¯æ’­æ”¾åœ°å€'); planLock=false; return;
        }
        playerOverlay.style.display='flex';
        initDPlayer(selectedVideoUrl, selectedCover);
        planLock = false;
      }, 3000);
    }

    function closePlayer(){
      playerOverlay.style.display='none';
      try{ dp?.pause(); dp?.destroy(); }catch(e){}
      dp = null;
    }

    // åˆå§‹åŒ–
    async function init(forceRetry=false){
      try{
        setStatus('æ­£åœ¨åŠ è½½åˆ†ç±»â€¦', true, false);
        categories = await API.categories();
        if(!Array.isArray(categories) || !categories.length) throw new Error('æ— åˆ†ç±»æ•°æ®');
        setStatus('', false, false);
        parentIdx = 0;
        switchToHome();
      }catch(e){
        console.error(e);
        setStatus('åŠ è½½åˆ†ç±»å¤±è´¥', false, true);
        if(forceRetry) showToast('åŠ è½½åˆ†ç±»å¤±è´¥');
      }
    }
    init();

    // å¯é€‰ï¼šå›¾ç‰‡ç¼“å­˜ SWï¼ˆäºŒæ¬¡è®¿é—®æ›´å¿«ï¼‰
    if('serviceWorker' in navigator){
      try{
        const code = `self.addEventListener('install',e=>self.skipWaiting());
        self.addEventListener('activate',e=>clients.claim());
        self.addEventListener('fetch',e=>{
          const r=e.request; if(r.destination==='image'){
            e.respondWith((async()=>{
              const c=await caches.open('img-cache-v1'); const m=await c.match(r);
              const f=fetch(r).then(res=>{c.put(r,res.clone());return res}).catch(()=>m);
              return m||f;
            })());
          }
        });`;
        const blob=new Blob([code],{type:'text/javascript'}); const url=URL.createObjectURL(blob);
        navigator.serviceWorker.register(url);
      }catch(e){ console.warn('SW register failed', e); }
    }
  </script>
</body>
</html>
